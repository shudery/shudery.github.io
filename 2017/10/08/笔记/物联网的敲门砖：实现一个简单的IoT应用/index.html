<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    
    <title>
       物联网的敲门砖：实现一个简单的IoT应用 -  Daguo&#39;s blog
    </title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <link rel="stylesheet" href="/css/style.css"> 
    <link rel="icon" href="/images/logo.jpg" />
    
  </head>
  <body>
    <div id="container">
      
      <div id="main-right"><div id="post">
  
  <header class="article-header">
    <h1>
      物联网的敲门砖：实现一个简单的IoT应用
    </h1>
  </header>
  
  <div class="post-meta">
    <time
      class="post-data"
      datetime="2017-10-08T15:32:17.000Z"
      itemprop="datePublished"
    >
      2017-10-08
    </time>
    <!-- 
        <ul class="post-category-list"><li class="post-category-list-item"><a class="post-category-list-link" href="/categories/笔记/">笔记</a><span class="post-category-list-count">17</span></li></ul>
         -->
     <ul class="post-tag-list"><li class="post-tag-list-item"><a class="post-tag-list-link" href="/tags/技术研究/">技术研究</a><span class="post-tag-list-count">3</span></li></ul> 
  </div>
  
  <div class="post-entry">
    <p>物联网概念的提出已久，业界早就有相应的实践和应用，受限于网络带宽和传感器技术，尚未普及，此外这种偏智能化的场景，注定需要一定的时间才能走进大众家庭。在物联网中，技术应用架构是怎样的，与传统互联网有何区别？为了弄清其中的关系和技术栈，我通过查阅资料，实现了一个典型的物联网智能场景，在这个过程随手整理了一些资料以及技术实现过程中踩的一些坑。</p>
<p>物联网和传统互联网的 CS 架构其实是相似的，都是前后端的交互通信，区别在于物联网往往有一个局域网链接客户端，局网中的设备 通过一些轻量的通讯协议交互，比如流行的 MQTT，也有直接使用蓝牙或者 WLAN 的，还有一台网关/路由作为中台，收集来自区域设备的数据，最终传递给云端服务器。如果硬要说还有什么区别，那就是在服务器端，往往还涉及到分布式，数据分析这些架构模块。以此来支持处理和分析来自设备的大量上传数据。</p>
<p>物联网的三个过程是：收集数据，传递数据和分析数据。对于收集数据而言，主要依赖传感器和相关的硬件模组，这也是软件工程师接触物联网比较感兴趣和有挑战的地方，因为涉及到一些硬件的技术内容；另外传递数据方面虽然依然采用 IP/TCP 的协议，但是相比传统的互联网，在应用层通讯协议方面已经不局限于采用 HTTP/HTTPS 了，在局域网中，依赖轻量级，低功耗的传输协议可以更大的发挥物联网设备的特点；至于数据分析层面则是现在飞速发展的互联网技术分支，也是目前物联网中相对成熟的模块，通过大数据实现数字世界和现实世界的 Digital Twin，通过数字世界的操控影响现实设备的表现。未来可以支持接入海量设备信息的大数据处理平台必定极具竞争力。在数据处理这一块由于我实现的只是一个简单的活动告警器，只是做一些简单的活动频率统计，所以不会实际都分布式和数据分析的内容。</p>
<p>上班的时候经常有这样一种场景，主管常常不在位置上，有时有事情想找主管，但又不是那种需要打电话直接找过去的事情，所以会特别希望主管一回到位置就能收到一个通知。刚好最近在看物联网的一些资料，这就衍生了我做一个监控告警的 IoT 应用的想法（没错，监视主管。目前暂时只实现了单设备，后续考虑接入多个监控设备，这样常年外出公干的大佬们一回来，我就能先过去挑几份好的礼物了。</p>
<p>说一下实现的思路，开始也说了，物联网关键的地方还是传感器和控制芯片这一块，其他实现方法用老的互联网那一套即可。由于之前接触过一些单片机和树莓派，对这些集成度高的板子还是比较放心的，考虑到社区生态和功能全面，所以就先用一台 Rspaberry 3B 来做实验（投入实用可以用一些更小的模组，比如 omega)，然后在某宝买了一套适配树莓派的传感器和杜邦线。其实一开始是打算用移动公司的 IoT 开发平台的，它提供了自带感应器的芯片模组，但是申请的开发板一直迟迟不给我发货，而且平台的 SDK 包是用 C 的，想写脚本的我不犹豫的跑路了。</p>
<p>由于是单设备的接入，而且树莓派本身就是一台功能强大的 Linux 服务器，所以直接拿来做中台，收集的数据发到搭架在我电脑上的服务器，服务器处理，分析，存储数据，同时提供操控物联网设备的服务以及推送 App 监控器报警的功能。App 采用 apache 给阿里孵化的全端开发框架 weex 写，这样可以一口气搞定 web，android，ios 三个平台的应用。app 可以控制活动监控器的告警灯以及是否开启监控。</p>
<p>先从设备客户端开始搞起，用 python 或者 js 都有相应支持树莓派 GPIO 接口的包文件，由于最近在看 Node-RED 这个基于 Nodejs 的可视化物联网编程框架，所以我就直接用 Nodejs 和 rpio 包写了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//监听传感器输出引脚</span></div><div class="line">rpio.open(LISTENT_PIN, rpio.INPUT, rpio.PULL_DOWN);</div><div class="line">rpio.poll(LISTENT_PIN, pin =&gt; &#123;</div><div class="line">    <span class="comment">// log(':the state of pin ' + pin + ' is '+ rpio.read(pin))</span></div><div class="line">    <span class="comment">//将监听信息推送到app</span></div><div class="line">    log(<span class="string">'[rpio-&gt;app-hock]request '</span> + WEB_HOCK);</div><div class="line">    <span class="keyword">var</span> time = <span class="keyword">new</span> <span class="built_in">Date</span>().toString().split(<span class="string">' '</span>).splice(<span class="number">1</span>,<span class="number">4</span>).join(<span class="string">'-'</span>);</div><div class="line">    <span class="keyword">var</span> cmdStr = <span class="string">`curl '<span class="subst">$&#123;WEB_HOCK&#125;</span>' \</div><div class="line">      -H 'Content-Type: application/json' \</div><div class="line">      -d '</div><div class="line">    &#123;</div><div class="line">      "text": "[<span class="subst">$&#123;time&#125;</span>]检测范围有人活动..",</div><div class="line">    &#125;'`</span>;</div><div class="line">    exec(cmdStr, <span class="function"><span class="keyword">function</span>(<span class="params">err,stdout,stderr</span>)</span>&#123;</div><div class="line">            err &amp;&amp; log(err);</div><div class="line">            <span class="comment">// console.log(stdout);</span></div><div class="line">    &#125;);</div><div class="line">    <span class="comment">//将监听信息发送至控制平台</span></div><div class="line">    log(<span class="string">'[rpio-&gt;server]request '</span> + CONSOLE_URL + <span class="string">'/warnSignal'</span>);</div><div class="line">    CONSOLE_URL &amp;&amp; http.get(CONSOLE_URL+<span class="string">'/warnSignal'</span>,(res)=&gt;&#123;</div><div class="line">        log(<span class="string">'[server-&gt;rpio] '</span>,res);</div><div class="line">    &#125;).on(<span class="string">'error'</span>,e=&gt;&#123;</div><div class="line">        log(<span class="string">'connect console server '</span>+CONSOLE_URL+<span class="string">' failed.'</span>);</div><div class="line">    &#125;)</div><div class="line">    <span class="comment">//只有在告警功能打开时才会闪烁</span></div><div class="line">    isWarnLEDFuncOn &amp;&amp; twinkLED(WARNLED_PIN, <span class="number">0.5</span>, <span class="number">2</span>);</div></pre></td></tr></table></figure>
<p>硬件方面比较简单，买了集成度高的活动传感器，支持 3-10 米的检测范围，0.5s-300s 的报警延时功能，参照树莓派的 GPIO 引脚功能表连接设备和 LED 灯，LED 灯接 3.3V 的引脚就够了，最好还要加个电阻，不加也没啥事。监听对应的引脚的跳高电压，当监听到活动时会给树莓派发送一个波峰电压。接到报警之后将信息传给后端服务器，点亮并闪烁报警的 LED 灯，此外由于告警数据不需要服务器进行处理，所以我直接发给了可以推送信息给 app 的 webHock 地址。这个服务很多类 slack 的协作工具都有提供，我这里用的是 bearychat 的 incoming 机器人。</p>
<p>然后就是写设备提供的接口，服务器通过这些接口可以控制设备的一些功能，比如 LED 灯的开关，告警功能的开关。还有要实现的就是 LED 灯的开关和闪烁函数，这个结合 rpio 的 API 文档，可以快速实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//提供服务</span></div><div class="line">server(&#123; port: SERVER_PORT &#125;, [</div><div class="line">  <span class="comment">//告警灯状态可控</span></div><div class="line">  get(<span class="string">'/offWarnLED'</span>, ctx =&gt; &#123;</div><div class="line">    log(<span class="string">' offWarnLED request is coming..'</span>);</div><div class="line">    offLED(WARNLED_PIN);</div><div class="line">  &#125;),</div><div class="line">  get(<span class="string">'/onWarnLED'</span>, ctx =&gt; &#123;</div><div class="line">    log(<span class="string">' onWarnLED request is coming..'</span>);</div><div class="line">    onLED(WARNLED_PIN);</div><div class="line">  &#125;),</div><div class="line">  get(<span class="string">'/twinkWarnLED'</span>, ctx =&gt; &#123;</div><div class="line">    log(<span class="string">' twinkWarnLED request is coming..'</span>);</div><div class="line">    twinkLED(WARNLED_PIN, <span class="number">1</span>);</div><div class="line">  &#125;),</div><div class="line">  get(<span class="string">'/changeWarnLED'</span>, ctx =&gt; &#123;</div><div class="line">    log(<span class="string">' changeWarnLED request is coming..'</span>);</div><div class="line">    changeLED(WARNLED_PIN);</div><div class="line">  &#125;),</div><div class="line">  <span class="comment">//是否开启告警灯功能</span></div><div class="line">  get(<span class="string">'/onWarnFunc'</span>, ctx =&gt; &#123;</div><div class="line">    isWarnLEDFuncOn = <span class="literal">true</span>;</div><div class="line">    log(<span class="string">' Warn Functoin is open now..'</span>);</div><div class="line">  &#125;),</div><div class="line">  get(<span class="string">'/offWarnFunc'</span>, ctx =&gt; &#123;</div><div class="line">    isWarnLEDFuncOn = <span class="literal">false</span>;</div><div class="line">    log(<span class="string">' Warn Functoin is close now....'</span>);</div><div class="line">  &#125;),</div><div class="line">  get(<span class="string">'/changeWarnFunc'</span>, ctx =&gt; &#123;</div><div class="line">    isWarnLEDFuncOn = isWarnLEDFuncOn ? <span class="literal">false</span> : <span class="literal">true</span>;</div><div class="line">    log(<span class="string">' Warn Functoin is'</span> + isWarnLEDFuncOn + <span class="string">'now....'</span>);</div><div class="line">  &#125;)</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>服务端方面本来是打算通过 webSocket 来和应用端实时通信，展示告警的状态，但是踩了 weex 的一个坑，没有搞出来，weex 的 android 中没有原生的 webSocket 实现，导致我在 web 调通的功能安装到 android 模拟器里后就不行了，后来实在找不齐 webSocket 实现所需要的库文件，而且考虑到场景不是很需要实时交互，所以就没有用这个方案了，后来想想其实用 ajax 长轮询做应该就没问题了。其他的功能就是接受设备的数据并储存，提供接口转发 app 端的控制请求给设备端，以及处理请求存储的告警信息内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//转发改变LED状态的请求</span></div><div class="line">app.get(<span class="string">'/changeWarnLED'</span>, (req, res) =&gt; &#123;</div><div class="line">  log(<span class="string">'[app-&gt;server]changeWarnLED'</span>);</div><div class="line">  http</div><div class="line">    .get(iotRouterUrl + <span class="string">'/changeWarnLED'</span>, resp =&gt; &#123;</div><div class="line">      res.send(<span class="string">'[server-&gt;app]ok!'</span>);</div><div class="line">    &#125;)</div><div class="line">    .on(<span class="string">'error'</span>, e =&gt; &#123;</div><div class="line">      log(e);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line"><span class="comment">//接收，存储设备的告警信息</span></div><div class="line">app.get(<span class="string">'/warnSignal'</span>, (req, res) =&gt; &#123;</div><div class="line">  log(<span class="string">'[rpio-&gt;server]somebody have a action now.'</span>);</div><div class="line">  res.send(<span class="string">'[server-&gt;rpio]The warn msg send success.'</span>);</div><div class="line">  <span class="comment">//存储信息</span></div><div class="line">  <span class="keyword">var</span> dateInfo = <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">    .toString()</div><div class="line">    .split(<span class="string">' '</span>)</div><div class="line">    .splice(<span class="number">1</span>, <span class="number">3</span>)</div><div class="line">    .join(<span class="string">'-'</span>);</div><div class="line">  <span class="keyword">var</span> timeInfo = <span class="keyword">new</span> <span class="built_in">Date</span>()</div><div class="line">    .toString()</div><div class="line">    .split(<span class="string">' '</span>)</div><div class="line">    .splice(<span class="number">4</span>, <span class="number">1</span>)</div><div class="line">    .join(<span class="string">'-'</span>);</div><div class="line">  <span class="keyword">var</span> store = &#123;</div><div class="line">    timeLabel: <span class="built_in">Date</span>.now(),</div><div class="line">    dateInfo,</div><div class="line">    timeInfo,</div><div class="line">    msgType: <span class="string">'warnSignal'</span></div><div class="line">  &#125;;</div><div class="line">  <span class="comment">//存储报警信息</span></div><div class="line">  fs.readFile(<span class="string">'store.json'</span>, <span class="string">'utf-8'</span>, (e, data) =&gt; &#123;</div><div class="line">    e &amp;&amp; <span class="built_in">console</span>.log(e);</div><div class="line">    <span class="keyword">var</span> data = <span class="built_in">JSON</span>.parse(data);</div><div class="line">    data.data.push(store);</div><div class="line">    fs.writeFile(<span class="string">'./store.json'</span>, <span class="built_in">JSON</span>.stringify(data), e =&gt; &#123;</div><div class="line">      e &amp;&amp; <span class="built_in">console</span>.log(e);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div><div class="line"><span class="comment">//返回报警数据</span></div><div class="line">app.get(<span class="string">'/data'</span>, (req, res) =&gt; &#123;</div><div class="line">  log(<span class="string">'[app-&gt;server]getData'</span>);</div><div class="line">  fs.readFile(<span class="string">'./store.json'</span>, <span class="string">'utf-8'</span>, (e, data) =&gt; &#123;</div><div class="line">    e &amp;&amp; <span class="built_in">console</span>.log(e);</div><div class="line">    log(<span class="string">'data number:'</span> + <span class="built_in">JSON</span>.parse(data).data.length);</div><div class="line">    res.send(data);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>应用端采用 weex/vue 的 js 全端开发框架，简单的写几个按钮，添加请求相应的接口地址，就能达到控制设备的作用。通过 weex-toolkit 可以在 web 端调试，打包，注意这个过程要有相应的 android 和 ios 开发环境，也就是说 jdk，android-sdk，安卓模拟器，xCode 都是需要的，这方面可以看看 weex 的 helloWorld 教程搭下环境。</p>
<p>在树莓派中跑起代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pi@raspberrypi:~<span class="regexp">/iot/</span>demo $ node rpio</div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-15</span>:<span class="number">01</span>:<span class="number">42</span>]server starts on <span class="number">8080</span> port</div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-15</span>:<span class="number">02</span>:<span class="number">11</span>][rpio-&gt;app-hock]request https:<span class="comment">//hook.bearychat.com/=bwBAI/incoming/55725fec1b3e3b629c8929ba0d41fefe</span></div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-15</span>:<span class="number">02</span>:<span class="number">11</span>][rpio-&gt;server]request http:<span class="comment">//192.168.31.170:8066/warnSignal</span></div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-15</span>:<span class="number">02</span>:<span class="number">12</span>][server-&gt;rpio]</div></pre></td></tr></table></figure>
<p>在服务端后台跑起 server</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@Daguo:) ~<span class="regexp">/code/i</span>ot/demo <span class="number">13</span>:<span class="number">38</span>:<span class="number">57</span> &gt;&gt;&gt;master!</div><div class="line">$ node <span class="built_in">console</span>.js</div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-13</span>:<span class="number">38</span>:<span class="number">58</span>]start server at <span class="number">8066.</span></div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-13</span>:<span class="number">39</span>:<span class="number">54</span>][rpio-&gt;server]somebody have a action now.</div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-14</span>:<span class="number">09</span>:<span class="number">44</span>][rpio-&gt;server]somebody have a action now.</div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-15</span>:<span class="number">02</span>:<span class="number">12</span>][rpio-&gt;server]somebody have a action now.</div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-15</span>:<span class="number">08</span>:<span class="number">54</span>][app-&gt;server]changeWarnLED</div><div class="line">[Oct<span class="number">-22</span><span class="number">-2017</span><span class="number">-15</span>:<span class="number">08</span>:<span class="number">55</span>][app-&gt;server]changeWarnLED</div></pre></td></tr></table></figure>
<p>当监控到环境中有物体活动后，bearyChat 应用会收到弹出消息，通过 app 也可以控制设备 LED 灯，至此完成了物联网应用的基础功能，更加详细的代码放在我的<a href="https://github.com/shudery/iot">github</a>上。后续还需要改进的地方包括接入多设备的支持，同时要采用新的轻量级协议连接局域网设备，路由对多设备数据的收集和发送，服务端的数据分析和计算，应用端的可视化数据界面展示。</p>

  </div>
</div>
</div>
    </div>
    <div id="footer">
      <a
        target="_blank"
        style="color: blue;"
        href="http://www.beian.miit.gov.cn"
        >粤ICP备18128256号</a
      >
    </div>
    
  </body>
</html>
<!-- 加载主题脚本文件 -->
<script src="/scripts/utone.js"></script>

<script type="text/javascript">
  window.onload = function() {
    scroll_fixed.init();
    // siteSearch.init()
  };
</script>
